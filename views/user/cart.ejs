<section>
  <div class="page-header text-center" style="background-image: url('/images/page-header-bg.jpg')">
    <div class="container">
      <h1 class="page-title">Shopping Cart<span>Shop</span></h1>
    </div><!-- End .container -->
  </div><!-- End .page-header -->
  <div class="page-content">
    <div class="cart">
      <div class="container">
        <div class="row">
          <div class="col-lg-9">
            <table class="table table-cart table-mobile">
              <% if(cartItems.length!=0){ %>
              <thead>
                <tr>
                  <th>Product</th>
                  <th>Price</th>
                  <th>Quantity</th>
                  <th>Total</th>
                  <th></th>
                </tr>
              </thead>
              <% } %>
              <tbody>
                <% if(cartItems.length!=0){ %>
                <% cartItems.forEach((element)=>{ %>
                <tr>
                  <td class="product-col" style="width: 300px;">
                    <div class="product">
                      <figure class="product-media">
                        <a href="/product/<%= element.product?._id %>">
                          <img src="/productImages/<%= element.product?._id %>0.jpg " alt="Product image">
                        </a>
                      </figure>

                      <h3 class="product-title">
                        <a href="/product/<%= element.product?._id %>">
                          <%= element.product?.name %>
                        </a>
                      </h3><!-- End .product-title -->
                    </div><!-- End .product -->
                  </td>
                  <td class="price-col">Rs <%= element.product?.price %>
                  </td>
                  <td class="quantity-col">
                    <div style="display: flex; width: 100px;" class="mt-4">
                      <button class="btn btn-decrement btn-spinner mb-4" <% if(element.quantity<2){ %> disabled <% } %> onclick="changeQuantity('<%= element?._id %>','<%= element?.product?._id %>',-1,this.parentElement.querySelector('input'),'<%= user._id %>','<%= element?.product?.price %>',)">
                        <i class="icon-minus"></i>
                      </button>
                      <input class="form-control bg-white" id="cartCount" style="text-align: center;" type="text" value="<%= element.quantity%>" disabled>
                      <button class="btn btn-increment btn-spinner mb-4" onclick="changeQuantity('<%= element?._id %>','<%= element?.product?._id %>',1,this.parentElement.querySelector('input'),'<%= user._id %>','<%= element?.product?.price %>')">
                        <i class="icon-plus"></i>
                      </button>
                    </div>


                  </td>
                  <td class="total-col" id="price">Rs <%= element?.product?.price*element?.quantity%>
                  </td>
                  <td class="remove-col"><button onclick="deleteCart('<%= element?._id%>','<%= element.product?._id%>')" class="btn-remove"><i class="icon-close"></i></button></td>
                </tr>


                <% }) %>
                <% }else{ %>
                <div class="row">
                  <div class="col-lg-12">
                    <h1 class=" mt-4 mx-1 mb-3 ">Cart is Empty</h1>
                  </div>
                </div>
                <% } %>
              </tbody>
            </table><!-- End .table table-wishlist -->

            <% if(cartItems.length!=0){ %>
            <div class="cart-bottom ">
              <div class="cart-discount">
                <form action="#">
                  <div class="input-group">
                    <input type="text" class="form-control" required placeholder="coupon code">
                    <div class="input-group-append">
                      <button class="btn btn-outline-primary-2" type="submit"><i class="icon-long-arrow-right"></i></button>
                    </div><!-- .End .input-group-append -->
                  </div><!-- End .input-group -->
                </form>
              </div><!-- End .cart-discount -->

            </div><!-- End .cart-bottom -->
          </div><!-- End .col-lg-9 -->
          <aside class="col-lg-3">
            <div class="summary summary-cart">
              <h3 class="summary-title">Cart Total</h3><!-- End .summary-title -->

              <table class="table table-summary">
                <tbody>
                  <tr class="summary-subtotal">
                    <td>Subtotal:</td>
                    <td id="subTotal">Rs <%= total %></td>
                  </tr><!-- End .summary-subtotal -->
                  <tr>
                  </tr>
                </tbody>
              </table><!-- End .table table-summary -->
              <a href="/checkout" class="btn btn-outline-primary-2 btn-order btn-block">PROCEED TO
                CHECKOUT</a>
            </div><!-- End .summary -->

            <a href="/shop" class="btn btn-outline-dark-2 btn-block mb-3"><span>CONTINUE
                SHOPPING</span><i class="icon-refresh"></i></a>
          </aside><!-- End .col-lg-3 -->
          <% }else{ %>
          <a href="/shop" class="btn btn-outline-dark-2 btn-block mb-3 w-50"><span>CONTINUE
              SHOPPING</span><i class="icon-refresh"></i></a>
          <% } %>
        </div><!-- End .row -->
      </div><!-- End .container -->
    </div><!-- End .cart -->
  </div><!-- End .page-content -->
</section>

<script>
  function changeQuantity(cartId, proId, count, input, userId, price, quantity) {
    $.ajax({
      url: '/changeProductQuantity',
      data: {
        cart: cartId,
        product: proId,
        count: count,
        user: userId,
        quantity: quantity
      },
      method: 'post',
      success: (response) => {
        if (response.status) {

          //header cart badge count
          let number = $('#cart-count').html()
          if (count > 0) {
            number = parseInt(number) + 1
          } else {
            number = parseInt(number) - 1
          }
          $('#cart-count').html(number)

          // +/- increment and decrement on input field
          let hey = input.value
          if (count > 0) {
            hey = parseInt(hey) + 1
            input.value = hey
          } else {
            hey = parseInt(hey) - 1
            input.value = hey
          }

          //Total price of each product
          TotalPrice = Number(price) * input.value
          let total = input.parentElement.parentElement.parentElement.querySelector('td.total-col')
          total.innerText = 'Rs ' + TotalPrice

          //button - disabling
          let btn = input.parentElement.querySelector('button.btn-decrement')
          if (input.value < 2) {
            btn.setAttribute('disabled', '');
          } else {
            btn.removeAttribute('disabled');
          }

          //Total product - Sub Total
          document.getElementById('subTotal').innerHTML = 'Rs ' + response.total

        }
      }
    })
  }

  function deleteCart(cartId, prodId) {
    $.ajax({
      url: '/deleteCartItems',
      data: {
        cart: cartId,
        product: prodId,
      },
      beforeSend: () => {
        return confirm('Are you sure want to remove product from cart ?')
      },
      method: 'post',
      success: (response) => {
        if (response.removeProduct) {
          location.reload()



        }
      }
    })
  }
</script>